name: Check Single Directory Changes

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches: [main]

jobs:
  check-single-directory:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce single directory per PR
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No changed files detected. Passing check."
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          DIRECTORIES=()

          while IFS= read -r FILE; do
            [[ -z "$FILE" ]] && continue

            # Ignore .github directory completely
            if [[ "$FILE" == .github/* ]]; then
              continue
            fi

            # Ignore root-level files (no slash in path), treated as config/root files
            if [[ "$FILE" != */* ]]; then
              echo "Ignoring root-level file: $FILE"
              continue
            fi

            TOP_LEVEL_DIR="${FILE%%/*}"

            # Ignore hidden directories
            if [[ "$TOP_LEVEL_DIR" == .* ]]; then
              echo "Ignoring hidden directory entry: $FILE"
              continue
            fi

            DIRECTORIES+=("$TOP_LEVEL_DIR")
          done <<< "$CHANGED_FILES"

          if [[ ${#DIRECTORIES[@]} -eq 0 ]]; then
            echo "Only root-level (config) files or ignored paths changed. Passing check."
            exit 0
          fi

          # Compute unique top-level directories
          UNIQUE_DIRS="$(printf "%s\n" "${DIRECTORIES[@]}" | sort -u)"

          echo "Top-level directories considered:"
          echo "$UNIQUE_DIRS"

          # Count unique directories excluding empty lines
          DIR_COUNT="$(printf "%s\n" "$UNIQUE_DIRS" | sed '/^$/d' | wc -l)"

          echo "Number of unique directories changed: $DIR_COUNT"

          # If no code directories changed, only config/ignored files – pass
          if [[ "$DIR_COUNT" -eq 0 ]]; then
            echo "PASS: Only root-level config files or ignored paths changed."
            exit 0
          fi

          # If more than one directory – fail (multi-directory change)
          if [[ "$DIR_COUNT" -gt 1 ]]; then
            echo "FAIL: Changes span multiple directories."
            echo "The following top-level directories were modified:"
            printf '  - %s\n' $UNIQUE_DIRS
            echo
            echo "Each PR must be scoped to a single top-level directory."
            echo "Example valid scenarios:"
            echo "  - Only 'src/auth/' changes"
            echo "  - Only 'frontend/components/' changes"
            echo "  - Only root-level config files (README.md, .gitignore, package.json, etc.)"
            echo "Example invalid scenarios:"
            echo "  - Changes in both 'backend/' AND 'frontend/'"
            echo "  - Changes in 'utils/', 'models/', and 'controllers/'"
            exit 1
          fi

          # At this point DIR_COUNT == 1: enforce PR title matches the single directory
          SINGLE_DIR="$(printf "%s\n" "$UNIQUE_DIRS" | sed '/^$/d')"
          # Trim leading/trailing whitespace from title
          TITLE="$(echo -e "${PR_TITLE}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"

          echo "Single changed directory: $SINGLE_DIR"
          echo "PR title: $TITLE"

          # [a-zA-Z0-9_-]+ - one or more letters, numbers, underscores or hyphens
          # $ - end of string
          PATTERN="^[a-z0-9]{6}-[a-zA-Z0-9_-]+$"

          if [[ ! "$TITLE" =~ $PATTERN ]]; then
            echo "FAIL: PR title does not match the required format."
            echo "Current title: '$TITLE'"
            echo "Expected format: 6 lowercase letters/digits + hyphen + letters/numbers/underscores/hyphens"
            echo "Example titles:"
            echo "  3gu4a1-Todo_list_app"
            echo "  8235d7-Test_LRU_cache_test_generation"
            echo "  13488f-Full_stack_ai_web_tool"
            exit 1
          fi

          if [[ "$TITLE" != "$SINGLE_DIR" ]]; then
            echo "FAIL: PR title does not match the changed directory."
            echo "Single changed directory: '$SINGLE_DIR'"
            echo "PR title:           '$TITLE'"
            echo
            echo "The PR title (after the hash prefix) should match the single"
            echo "top-level directory being changed, for example:"
            echo "  Directory: 3gu4a1-Todo_list_app"
            echo "  PR title:  3gu4a1-Todo_list_app"
            exit 1
          fi

          echo "PASS: Changes are scoped to a single directory and PR title matches it."
          exit 0

