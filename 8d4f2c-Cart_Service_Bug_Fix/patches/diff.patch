--- repository_before/cartService.js	2026-01-15 22:52:04.238521785 +0300
+++ repository_after/cartService.js	2026-01-15 23:57:12.744830011 +0300
@@ -65,6 +65,10 @@
     try {
       const { menuItemId, quantity, variations = [], addOns = [] } = itemData;
 
+      if (!Number.isInteger(quantity) || quantity <= 0) {
+        throw new HttpError("Quantity must be a positive integer", 400);
+      }
+
       const menuItem = await MenuItem.findById(menuItemId).lean();
       if (!menuItem) {
         throw new HttpError("Menu item not found", 404);
@@ -97,10 +101,9 @@
         const validFrom = menuItem.discount.validFrom ? new Date(menuItem.discount.validFrom) : null;
         const validUntil = menuItem.discount.validUntil ? new Date(menuItem.discount.validUntil) : null;
         
-        if ((validFrom && now < validFrom) || (validUntil && now > validUntil)) {
-          if (menuItem.discountedPrice) {
-            basePrice = parseFloat(menuItem.discountedPrice.toString());
-          }
+        const isWithinDateRange = (!validFrom || now >= validFrom) && (!validUntil || now <= validUntil);
+        if (isWithinDateRange && menuItem.discountedPrice) {
+          basePrice = parseFloat(menuItem.discountedPrice.toString());
         }
       }
 
@@ -114,23 +117,6 @@
         };
       }).filter(Boolean); 
 
-      let cart = await Cart.findOne({ customerId });
-      if (!cart) {
-        cart = new Cart({
-          customerId,
-          merchantId: menuItem.merchantId,
-          items: []
-        });
-      }
-
-      const existingItem = cart.items.find(item => {
-        return item.menuItemId.toString() === menuItem._id.toString();
-      });
-
-      if (existingItem) {
-        throw new HttpError("This exact item configuration is already in your cart.", 409);
-      }
-
       const addOnsTotal = addOnsWithPrices.reduce((total, addon) => total + addon.price, 0);
       const singleItemPrice = basePrice + addOnsTotal;
       const subtotal = singleItemPrice * quantity;
@@ -144,11 +130,58 @@
         addOns: addOnsWithPrices,
         subtotal,
       };
-      cart.items.push(newItem);
 
-      await cart.save();
+      // Use atomic operation to prevent duplicates and validate merchant
+      let result = await Cart.findOneAndUpdate(
+        {
+          customerId,
+          'items.menuItemId': { $ne: menuItem._id },
+          $or: [
+            { merchantId: menuItem.merchantId },
+            { merchantId: { $exists: false } },
+            { merchantId: null }
+          ]
+        },
+        {
+          $set: { merchantId: menuItem.merchantId },
+          $push: { items: newItem },
+          $inc: { 'pricing.subtotal': subtotal, 'pricing.totalItems': quantity }
+        },
+        { new: true }
+      );
+
+      // If no cart was updated, either no cart exists or conditions failed
+      if (!result) {
+        const existingCart = await Cart.findOne({ customerId });
+        if (existingCart) {
+          // Cart exists but update failed - check why
+          if (existingCart.items.some(item => item.menuItemId.toString() === menuItem._id.toString())) {
+            throw new HttpError("This exact item configuration is already in your cart.", 409);
+          }
+          if (existingCart.merchantId && existingCart.items.length > 0 &&
+              existingCart.merchantId.toString() !== menuItem.merchantId.toString()) {
+            throw new HttpError("Cannot add items from different merchants to the same cart", 400);
+          }
+        }
+        // No cart exists, create new one
+        const newCart = new Cart({
+          customerId,
+          merchantId: menuItem.merchantId,
+          items: [newItem],
+          pricing: { subtotal, totalItems: quantity }
+        });
+        try {
+          result = await newCart.save();
+        } catch (err) {
+          // Race condition - another request created the cart
+          if (err.code === 11000) {
+            throw new HttpError("This exact item configuration is already in your cart.", 409);
+          }
+          throw err;
+        }
+      }
 
-      await cart.populate({
+      await result.populate({
         path: 'items.menuItemId',
         populate: {
             path: 'merchantId', 
@@ -157,7 +190,7 @@
         }
       });
 
-      return cart;
+      return result;
     } catch (error) {
       logger.error(`Error adding to cart: ${error.message}`);
       throw error;
@@ -167,6 +200,11 @@
   async updateCartItem(customerId, itemId, updateData) {
     try {
       const { quantity, addOns, variations } = updateData;
+
+      if (quantity !== undefined && (!Number.isInteger(quantity) || quantity < 0)) {
+        throw new HttpError("Quantity must be a non-negative integer", 400);
+      }
+
       const cart = await Cart.findOne({ customerId });
       if (!cart) {
         throw new HttpError("Cart not found", 404);
@@ -224,6 +262,10 @@
         cartItem.subtotal = newSubtotal;
       }
 
+      // Recalculate cart pricing
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
       return cart;
     } catch (error) {
@@ -243,8 +285,12 @@
         (item) => item._id.toString() !== itemId
       );
 
+      // Recalculate cart pricing
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
-      return null;
+      return cart;
     } catch (error) {
       logger.error(`Error removing from cart: ${error.message}`);
       throw error;
@@ -259,8 +305,10 @@
       }
 
       cart.items = [];
+      cart.pricing.subtotal = 0;
+      cart.pricing.totalItems = 0;
       await cart.save();
-      return null;
+      return cart;
     } catch (error) {
       logger.error(`Error clearing cart: ${error.message}`);
       throw error;
