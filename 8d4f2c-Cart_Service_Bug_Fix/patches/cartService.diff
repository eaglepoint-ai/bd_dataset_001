--- repository_before/cartService.js	2026-01-15 14:52:40.170072500 +0300
+++ repository_after/cartService.js	2026-01-15 15:06:15.595620500 +0300
@@ -65,6 +65,11 @@
     try {
       const { menuItemId, quantity, variations = [], addOns = [] } = itemData;
 
+      // Bug fix: Validate quantity is a positive integer greater than zero
+      if (!Number.isInteger(quantity) || quantity <= 0) {
+        throw new HttpError("Quantity must be a positive integer greater than zero", 400);
+      }
+
       const menuItem = await MenuItem.findById(menuItemId).lean();
       if (!menuItem) {
         throw new HttpError("Menu item not found", 404);
@@ -97,10 +102,10 @@
         const validFrom = menuItem.discount.validFrom ? new Date(menuItem.discount.validFrom) : null;
         const validUntil = menuItem.discount.validUntil ? new Date(menuItem.discount.validUntil) : null;
         
-        if ((validFrom && now < validFrom) || (validUntil && now > validUntil)) {
-          if (menuItem.discountedPrice) {
-            basePrice = parseFloat(menuItem.discountedPrice.toString());
-          }
+        // Bug fix: Apply discount when WITHIN date range (was inverted)
+        const isWithinDateRange = (!validFrom || now >= validFrom) && (!validUntil || now <= validUntil);
+        if (isWithinDateRange && menuItem.discountedPrice) {
+          basePrice = parseFloat(menuItem.discountedPrice.toString());
         }
       }
 
@@ -121,6 +126,18 @@
           merchantId: menuItem.merchantId,
           items: []
         });
+      } else if (cart.items.length > 0) {
+        // Bug fix: Throw error when adding item from different merchant
+        const cartMerchantId = cart.merchantId ? cart.merchantId.toString() : null;
+        const itemMerchantId = menuItem.merchantId.toString();
+        
+        if (cartMerchantId && cartMerchantId !== itemMerchantId) {
+          throw new HttpError("Cannot add items from different merchants. Please clear your cart first.", 400);
+        }
+        // Bug fix: Handle edge case when cart has items but merchantId is not set
+        if (!cartMerchantId) {
+          cart.merchantId = menuItem.merchantId;
+        }
       }
 
       const existingItem = cart.items.find(item => {
@@ -144,8 +161,25 @@
         addOns: addOnsWithPrices,
         subtotal,
       };
-      cart.items.push(newItem);
 
+      // Bug fix: Use atomic operation to prevent duplicate items on concurrent requests
+      const updateResult = await Cart.findOneAndUpdate(
+        { customerId, 'items.menuItemId': { $ne: menuItem._id } },
+        { 
+          $push: { items: newItem },
+          $set: { merchantId: menuItem.merchantId }
+        },
+        { new: true, upsert: true, setDefaultsOnInsert: true }
+      );
+
+      if (!updateResult) {
+        throw new HttpError("This exact item configuration is already in your cart.", 409);
+      }
+      cart = updateResult;
+
+      // Bug fix: Recalculate cart pricing after adding item
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
       await cart.save();
 
       await cart.populate({
@@ -224,6 +258,10 @@
         cartItem.subtotal = newSubtotal;
       }
 
+      // Bug fix: Recalculate cart pricing after any item modification
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
       return cart;
     } catch (error) {
@@ -243,8 +281,13 @@
         (item) => item._id.toString() !== itemId
       );
 
+      // Bug fix: Recalculate cart pricing after removal
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
-      return null;
+      // Bug fix: Return updated cart instead of null
+      return cart;
     } catch (error) {
       logger.error(`Error removing from cart: ${error.message}`);
       throw error;
@@ -259,8 +302,11 @@
       }
 
       cart.items = [];
+      // Bug fix: Reset pricing when clearing cart
+      cart.pricing.subtotal = 0;
+      cart.pricing.totalItems = 0;
       await cart.save();
-      return null;
+      return cart;
     } catch (error) {
       logger.error(`Error clearing cart: ${error.message}`);
       throw error;
