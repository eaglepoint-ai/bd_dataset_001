--- repository_before/cartService.js	2026-01-15 14:52:40.170072500 +0300
+++ repository_after/cartService.js	2026-01-15 16:26:56.422788800 +0300
@@ -5,6 +5,35 @@
 const logger = require("./config/logger");
 
 class CartService {
+  // BUG FIX 9: Helper to convert Decimal128 values to numbers
+  _formatCartResponse(cart) {
+    if (!cart) {
+      return { _id: null, items: [], pricing: { subtotal: 0, totalItems: 0 } };
+    }
+    return {
+      _id: cart._id,
+      merchantId: cart.merchantId,
+      items: cart.items.map(item => ({
+        _id: item._id,
+        menuItemId: item.menuItemId?._id || item.menuItemId,
+        name: item.name,
+        price: parseFloat(item.price?.toString() || '0'),
+        quantity: item.quantity,
+        variations: item.variations,
+        addOns: (item.addOns || []).map(a => ({
+          _id: a._id,
+          name: a.name,
+          price: parseFloat(a.price?.toString() || '0')
+        })),
+        subtotal: parseFloat(item.subtotal?.toString() || '0'),
+      })),
+      pricing: {
+        subtotal: parseFloat(cart.pricing?.subtotal?.toString() || '0'),
+        totalItems: cart.pricing?.totalItems || 0
+      }
+    };
+  }
+
   async getCart(customerId) {
     try {
       const cart = await Cart.findOne({ customerId })
@@ -65,6 +94,11 @@
     try {
       const { menuItemId, quantity, variations = [], addOns = [] } = itemData;
 
+      // BUG FIX 2: Validate quantity is a positive integer greater than zero
+      if (!Number.isInteger(quantity) || quantity <= 0) {
+        throw new HttpError("Quantity must be a positive integer greater than zero", 400);
+      }
+
       const menuItem = await MenuItem.findById(menuItemId).lean();
       if (!menuItem) {
         throw new HttpError("Menu item not found", 404);
@@ -92,15 +126,15 @@
       
       let basePrice = variantPrice !== null ? variantPrice : parseFloat(menuItem.price.toString());
       
+      // BUG FIX 4: Fix inverted discount logic - apply discount when within date range
       if (menuItem.discount && menuItem.discount.isActive) {
         const now = new Date();
         const validFrom = menuItem.discount.validFrom ? new Date(menuItem.discount.validFrom) : null;
         const validUntil = menuItem.discount.validUntil ? new Date(menuItem.discount.validUntil) : null;
         
-        if ((validFrom && now < validFrom) || (validUntil && now > validUntil)) {
-          if (menuItem.discountedPrice) {
-            basePrice = parseFloat(menuItem.discountedPrice.toString());
-          }
+        const isWithinDateRange = (!validFrom || now >= validFrom) && (!validUntil || now <= validUntil);
+        if (isWithinDateRange && menuItem.discountedPrice) {
+          basePrice = parseFloat(menuItem.discountedPrice.toString());
         }
       }
 
@@ -121,6 +155,15 @@
           merchantId: menuItem.merchantId,
           items: []
         });
+      } else {
+        // BUG FIX 1: Check merchant mismatch
+        if (cart.merchantId && cart.merchantId.toString() !== menuItem.merchantId.toString()) {
+          throw new HttpError("Cannot add items from different merchants. Please clear your cart first.", 400);
+        }
+        // BUG FIX 8: Set merchantId if cart exists but merchantId is not set
+        if (!cart.merchantId) {
+          cart.merchantId = menuItem.merchantId;
+        }
       }
 
       const existingItem = cart.items.find(item => {
@@ -146,6 +189,11 @@
       };
       cart.items.push(newItem);
 
+      // BUG FIX 6 & 7: Recalculate cart pricing after adding item
+      cart.pricing = cart.pricing || { subtotal: 0, totalItems: 0 };
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
 
       await cart.populate({
@@ -157,7 +205,8 @@
         }
       });
 
-      return cart;
+      // BUG FIX 9: Return cart with Decimal128 values converted to numbers
+      return this._formatCartResponse(cart);
     } catch (error) {
       logger.error(`Error adding to cart: ${error.message}`);
       throw error;
@@ -224,8 +273,13 @@
         cartItem.subtotal = newSubtotal;
       }
 
+      // BUG FIX 6 & 7: Recalculate cart pricing after update
+      cart.pricing = cart.pricing || { subtotal: 0, totalItems: 0 };
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
-      return cart;
+      return this._formatCartResponse(cart);
     } catch (error) {
       logger.error(`Error updating cart item: ${error.message}`);
       throw error;
@@ -243,8 +297,14 @@
         (item) => item._id.toString() !== itemId
       );
 
+      // BUG FIX 6 & 7: Recalculate cart pricing after removal
+      cart.pricing = cart.pricing || { subtotal: 0, totalItems: 0 };
+      cart.pricing.subtotal = cart.items.reduce((sum, item) => sum + parseFloat(item.subtotal.toString()), 0);
+      cart.pricing.totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
+
       await cart.save();
-      return null;
+      // BUG FIX 5: Return updated cart instead of null
+      return this._formatCartResponse(cart);
     } catch (error) {
       logger.error(`Error removing from cart: ${error.message}`);
       throw error;
@@ -259,8 +319,9 @@
       }
 
       cart.items = [];
+      cart.pricing = { subtotal: 0, totalItems: 0 };
       await cart.save();
-      return null;
+      return this._formatCartResponse(cart);
     } catch (error) {
       logger.error(`Error clearing cart: ${error.message}`);
       throw error;
